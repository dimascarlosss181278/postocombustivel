unit Principal;

interface

uses
  Windows, Messages, SysUtils, Classes, Graphics, Controls, Forms, Dialogs,
  StdCtrls, Spin, ComCtrls,ExtCtrls, jpeg, dllcompanytec;

type
  TForm1 = class(TForm)
    PageControl: TPageControl;
    Abastecimentos: TTabSheet;
    TabSheet1: TTabSheet;
    PageControl1: TPageControl;
    TabSheet2: TTabSheet;
    Label1: TLabel;
    SpinEdit1: TSpinEdit;
    Button1: TButton;
    Button2: TButton;
    Panel1: TPanel;
    RadioButton1: TRadioButton;
    RadioButton2: TRadioButton;
    Button3: TButton;
    GroupBox5: TGroupBox;
    Label3: TLabel;
    Label4: TLabel;
    Label5: TLabel;
    Label6: TLabel;
    Label7: TLabel;
    Label8: TLabel;
    Label9: TLabel;
    Label10: TLabel;
    Label11: TLabel;
    Label2: TLabel;
    EditTotaisDin: TEdit;
    EditTotaisLT: TEdit;
    EditPPL: TEdit;
    EditTempo: TEdit;
    EditCanal: TEdit;
    EditData: TEdit;
    EditHora: TEdit;
    EditRegistro: TEdit;
    EditEnc: TEdit;
    EditString: TEdit;
    GroupBox1: TGroupBox;
    Check: TCheckBox;
    value: TCheckBox;
    integridade: TCheckBox;
    PageControl2: TPageControl;
    TabSheet3: TTabSheet;
    Panel2: TPanel;
    Button4: TButton;
    Panel3: TPanel;
    Memo1: TMemo;
    TabSheet4: TTabSheet;
    Panel4: TPanel;
    Button5: TButton;
    Memo2: TMemo;
    TabSheet5: TTabSheet;
    TabSheet6: TTabSheet;
    TabSheet7: TTabSheet;
    Memo3: TMemo;
    Panel5: TPanel;
    Button7: TButton;
    Memo4: TMemo;
    Panel6: TPanel;
    Button8: TButton;
    Memo5: TMemo;
    Panel7: TPanel;
    Button9: TButton;
    SpinEdit2: TSpinEdit;
    ListBox1: TListBox;
    Button6: TButton;
    Button10: TButton;
    Memo6: TMemo;
    TabSheet8: TTabSheet;
    ListBox2: TListBox;
    Button11: TButton;
    Edit1: TEdit;
    Button12: TButton;
    StatusBar1: TStatusBar;
    TabSheet9: TTabSheet;
    Button14: TButton;
    Button15: TButton;
    Button16: TButton;
    Button17: TButton;
    Button18: TButton;
    Button19: TButton;
    Button20: TButton;
    Edit2: TEdit;
    Edit3: TEdit;
    Edit4: TEdit;
    Label12: TLabel;
    Label13: TLabel;
    Label14: TLabel;
    Label15: TLabel;
    ComboBox1: TComboBox;
    RadioButton3: TRadioButton;
    Label16: TLabel;
    Edit5: TEdit;
    Label17: TLabel;
    Edit6: TEdit;
    Label18: TLabel;
    Edit7: TEdit;
    RadioButton4: TRadioButton;
    Edit8: TEdit;
    Label19: TLabel;
    Label20: TLabel;
    Edit9: TEdit;
    Label21: TLabel;
    Edit10: TEdit;
    RadioButton5: TRadioButton;
    Edit11: TEdit;
    Label22: TLabel;
    Edit12: TEdit;
    Label23: TLabel;
    TabSheet10: TTabSheet;
    GroupBox2: TGroupBox;
    Label24: TLabel;
    Edit13: TEdit;
    Label25: TLabel;
    ComboBox2: TComboBox;
    Label26: TLabel;
    Edit14: TEdit;
    Button13: TButton;
    GroupBox3: TGroupBox;
    Label27: TLabel;
    Label28: TLabel;
    Label29: TLabel;
    Edit15: TEdit;
    Edit16: TEdit;
    Button21: TButton;
    Label30: TLabel;
    Edit17: TEdit;
    SpinEdit3: TSpinEdit;
    GroupBox4: TGroupBox;
    Label31: TLabel;
    Edit18: TEdit;
    Button22: TButton;
    Label32: TLabel;
    Edit19: TEdit;
    Panel9: TPanel;
    RadioButton9: TRadioButton;
    Button23: TButton;
    ComboBox3: TComboBox;
    Label33: TLabel;
    Shape1: TShape;
    Label34: TLabel;
    Image1: TImage;
    TabSheet11: TTabSheet;
    Edit20: TEdit;
    Button24: TButton;
    Button25: TButton;
    Button27: TButton;
    TabSheet12: TTabSheet;
    Button26: TButton;
    Label35: TLabel;
    EditTag: TEdit;
    TabSheet13: TTabSheet;
    Button28: TButton;
    Memo7: TMemo;
    GroupBox6: TGroupBox;
    Label36: TLabel;
    Label37: TLabel;
    Edit21: TEdit;
    Button29: TButton;
    Edit22: TEdit;
    TabSheet14: TTabSheet;
    Edit23: TEdit;
    Label38: TLabel;
    Button30: TButton;
    Button31: TButton;
    Panel8: TPanel;
    RadioButton6: TRadioButton;
    RadioButton7: TRadioButton;
    Button32: TButton;
    GroupBox7: TGroupBox;
    Edit24: TEdit;
    Label39: TLabel;
    Label40: TLabel;
    Edit25: TEdit;
    Button33: TButton;
    Button34: TButton;
    TabSheet15: TTabSheet;
    Edit26: TEdit;
    Button35: TButton;
    Edit27: TEdit;
    Button36: TButton;
    function ErrorToString(Erro:Error):string;
    procedure Button1Click(Sender: TObject);
    procedure Button2Click(Sender: TObject);
    procedure Button3Click(Sender: TObject);
    procedure Button4Click(Sender: TObject);
    procedure Button9Click(Sender: TObject);
    procedure Button5Click(Sender: TObject);
    procedure Button7Click(Sender: TObject);
    procedure Button8Click(Sender: TObject);
    procedure Button6Click(Sender: TObject);
    procedure Button10Click(Sender: TObject);
    procedure Button11Click(Sender: TObject);
    procedure Button12Click(Sender: TObject);
    procedure Button14Click(Sender: TObject);
    procedure Button15Click(Sender: TObject);
    procedure Button16Click(Sender: TObject);
    procedure Button17Click(Sender: TObject);
    procedure Button18Click(Sender: TObject);
    procedure Button19Click(Sender: TObject);
    procedure Button20Click(Sender: TObject);
    procedure Button13Click(Sender: TObject);
    procedure Button21Click(Sender: TObject);
    procedure Button22Click(Sender: TObject);
    procedure Button23Click(Sender: TObject);
    procedure Button24Click(Sender: TObject);
    procedure Button25Click(Sender: TObject);
    procedure Button26Click(Sender: TObject);
    procedure Button27Click(Sender: TObject);
    procedure Button28Click(Sender: TObject);
    procedure Button29Click(Sender: TObject);
    procedure Button30Click(Sender: TObject);
    procedure Button31Click(Sender: TObject);
    procedure Button32Click(Sender: TObject);
    procedure Button33Click(Sender: TObject);
    procedure Button34Click(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure Button35Click(Sender: TObject);
    procedure Button36Click(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var Form1: TForm1;


implementation

{$R *.DFM}

procedure TForm1.Button1Click(Sender: TObject);
begin
Radiobutton1.Checked:=InicializaSerial(spinedit1.Value);
RadioButton2.Checked:=not RadioButton1.Checked;
Button1.Enabled:=not RadioButton1.Checked;
Button2.Enabled:=not Button1.Enabled;
end;

procedure TForm1.Button2Click(Sender: TObject);
begin
if FechaSerial<>0 then Radiobutton1.Checked:=true else Radiobutton1.Checked:=false;
RadioButton2.Checked:=not RadioButton1.Checked;
Button1.Enabled:=not RadioButton1.Checked;
Button2.Enabled:=not Button1.Enabled;
end;

procedure TForm1.Button3Click(Sender: TObject);
begin
RadioButton1.Checked:=PortOpen;
RadioButton2.Checked:=not RadioButton1.Checked;
Button1.Enabled:=not RadioButton1.Checked;
Button2.Enabled:=not Button1.Enabled;
end;

//------------------------------------------------------------------------------
procedure TForm1.Button4Click(Sender: TObject);
var ab:abast;
begin
ab:=LeAbastecimento;
editTotaisDin.Text:=floattostr(ab.total_dinheiro);
editString.Text:=ab.st_full;
editTotaisLt.Text:=floattostr(ab.total_litros);
editPPL.Text:=floattostr(ab.PU);
editTempo.Text:=ab.tempo;
editCanal.Text:=ab.canal;
editData.Text:=ab.data;
editHora.text:=ab.hora;
editRegistro.Text:=floattostr(ab.registro);
editEnc.Text:=floattostr(ab.encerrante);
check.Checked:=ab.checksum;
integridade.Checked:=ab.integridade;
value.Checked:=ab.value;
end;

//------------------------------------------------------------------------------
procedure TForm1.Button9Click(Sender: TObject);
var ab:abast;
begin
ab:=LeRegistro(SpinEdit2.Value);
editTotaisDin.Text:=floattostr(ab.total_dinheiro);
editString.Text:=ab.st_full;
editTotaisLt.Text:=floattostr(ab.total_litros);
editPPL.Text:=floattostr(ab.PU);
editTempo.Text:=ab.tempo;
editCanal.Text:=ab.canal;
editData.Text:=ab.data;
editHora.text:=ab.hora;
editRegistro.Text:=floattostr(ab.registro);
editEnc.Text:=floattostr(ab.encerrante);
check.Checked:=ab.checksum;
integridade.Checked:=ab.integridade;
value.Checked:=ab.value;
end;

//------------------------------------------------------------------------------
procedure TForm1.Button5Click(Sender: TObject);
var ab:abast2;
begin
LeStructSt(ab);
editTotaisDin.Text:=ab.total_dinheiro;
editString.Text:=ab.st_full;
editTotaisLt.Text:=ab.total_litros;
editPPL.Text:=ab.PU;
editTempo.Text:=ab.tempo;
editCanal.Text:=ab.canal;
editData.Text:=ab.data;
editHora.text:=ab.hora;
editRegistro.Text:=ab.registro;
editEnc.Text:=ab.encerrante;
if ab.checksum='1' then check.Checked:=true else check.Checked:=false;
if ab.integridade='1' then integridade.Checked:=true else integridade.Checked:=false;
if ab.value='1' then value.Checked:=true else value.Checked:=false;
end;

//------------------------------------------------------------------------------
procedure TForm1.Button7Click(Sender: TObject);
var ab:abast;
begin
ab:=LeAbFix;
editTotaisDin.Text:=floattostr(ab.total_dinheiro);
editString.Text:=ab.st_full;
editTotaisLt.Text:=floattostr(ab.total_litros);
editPPL.Text:=floattostr(ab.PU);
editTempo.Text:=ab.tempo;
editCanal.Text:=ab.canal;
editData.Text:=ab.data;
editHora.text:=ab.hora;
editRegistro.Text:=floattostr(ab.registro);
editEnc.Text:=floattostr(ab.encerrante);
check.Checked:=ab.checksum;
integridade.Checked:=ab.integridade;
value.Checked:=ab.value;
end;

//------------------------------------------------------------------------------
procedure TForm1.Button8Click(Sender: TObject);
var ab:abast2;
begin
CobLeStructSt(ab);
editTotaisDin.Text:=ab.total_dinheiro;
editString.Text:=ab.st_full;
editTotaisLt.Text:=ab.total_litros;
editPPL.Text:=ab.PU;
editTempo.Text:=ab.tempo;
editCanal.Text:=ab.canal;
editData.Text:=ab.data;
editHora.text:=ab.hora;
editRegistro.Text:=ab.registro;
editEnc.Text:=ab.encerrante;
if ab.checksum='1' then check.Checked:=true else check.Checked:=false;
if ab.integridade='1' then integridade.Checked:=true else integridade.Checked:=false;
if ab.value='1' then value.Checked:=true else value.Checked:=false;
end;

//------------------------------------------------------------------------------
procedure TForm1.Button6Click(Sender: TObject);
var ol:online;
    a:byte;
begin
ol:=LeVisualizacao;
for a:=1 to 48 do
    ListBox1.Items.Add(ol.Bico[a] + ' - ' + floattostr(ol.Litragem[a]));
end;

//------------------------------------------------------------------------------------------------------------
procedure TForm1.Button10Click(Sender: TObject);
var stvis:Shortstring;
begin
STVisualizacao(stvis);
Memo6.Lines.Add(stvis);
end;

//------------------------------------------------------------------------------------------------------------
procedure TForm1.Button11Click(Sender: TObject);
var ms:multistatus;
    a:byte;
begin
ms:=LeStatus;
for a:=1 to 32 do
    begin
    case ms.Status[a] of
    Livre:ListBox2.Items.Add(inttostr(a) + ' (L) - Livre');
    Pronta:ListBox2.Items.Add(inttostr(a) + ' (P) - Pronto');
    Falha:ListBox2.Items.Add(inttostr(a) + ' (F) - Falha');
    Concluiu:ListBox2.Items.Add(inttostr(a) + ' (C) - Concluiu');
    Abastecendo:ListBox2.Items.Add(inttostr(a) + ' (A) - Abastecimento');
    Bloqueada:ListBox2.Items.Add(inttostr(a) + ' (B) - Bloqueado');
    SolicitaLib:ListBox2.Items.Add(inttostr(a) + ' (E) - Espera');
    end;
    end;
end;




procedure TForm1.Button12Click(Sender: TObject);
begin
edit1.Text:=LeStStatus.value;
end;

procedure TForm1.Button14Click(Sender: TObject);
var rta:IFid;
begin
rta:=FidIdent;
if rta.Value then
    edit2.text:=rta.StFull
else
    edit2.Text:='';
end;

procedure TForm1.Button15Click(Sender: TObject);
var rta:StFid;
begin
rta:=FidStatus;
edit3.text:=rta.Status;
end;

procedure TForm1.Button16Click(Sender: TObject);
begin
radiobutton3.Checked:=false;
if FidModo(edit4.text,combobox1.text[1])=1 then
    radiobutton3.Checked:=true
else
    radiobutton3.Checked:=false;
end;

procedure TForm1.Button17Click(Sender: TObject);
begin
if FidAciona(edit5.text,strtoint(edit5.text),strtoint(edit7.text))=1 then
    radiobutton4.Checked:=true
else
    radiobutton4.Checked:=false;
end;



procedure TForm1.Button18Click(Sender: TObject);
begin
if FidSetClock(strtoint(edit8.text),strtoint(edit9.text),strtoint(edit10.text))=1 then
    radiobutton5.Checked:=true
else
    radiobutton5.Checked:=false;
end;

procedure TForm1.Button19Click(Sender: TObject);
begin
edit11.text:=FidLeRegistro(strtoint(edit12.text));
end;



procedure TForm1.Button20Click(Sender: TObject);
begin
FidIncrementa;
end;




procedure TForm1.Button13Click(Sender: TObject);
var st:encerrante;
begin
st:=ConsultaEncerrante(combobox2.text[1],edit13.text);
edit14.text:='Bico:' + st.Bico + ' Total:' + floattostr(st.valor);
end;

procedure TForm1.Button21Click(Sender: TObject);
var erro:error;
begin
erro:=AlteraPreco(edit15.text,strtofloat(edit17.text),spinedit3.Value);
Edit16.text:=ErrorToString(erro);
end;

function TForm1.ErrorToString(Erro:Error):string;
begin
if Erro=ErroString then result:='ErroString' else
if Erro=None then result:='Ok' else
if Erro=ErroCodBico then result:='ErroCodBico' else
if Erro=ErroCaracterModo then result:='ErroCaracterModo' else
if Erro=ErroTimeout then result:='ErroTimeout' else
if Erro=ErroResposta then result:='ErroResposta' else
result:='ErroResposta';
end;

procedure TForm1.Button22Click(Sender: TObject);
var erro:error;
begin
erro:=None;
if Combobox3.Text[1]='L' then erro:=AutoLibera(edit18.text) else
if Combobox3.Text[1]='B' then erro:=BloqueiaBico(edit18.text) else
if Combobox3.Text[1]='A' then erro:=AutorizaAbast(edit18.text);
Edit19.text:=ErrorToString(erro);
end;

procedure TForm1.Button23Click(Sender: TObject);
begin
RadioButton9.Checked:=Comunica;
end;

procedure TForm1.Button24Click(Sender: TObject);
begin
edit20.text:=LeStringAbVb;
end;

procedure TForm1.Button25Click(Sender: TObject);
begin
edit20.text:=LeStStatus2;
end;

procedure TForm1.Button26Click(Sender: TObject);
var ab:abastFid;
begin
ab:=LeAbastecimentoFid;
editTotaisDin.Text:=floattostr(ab.total_dinheiro);
editString.Text:=ab.st_full;
editTotaisLt.Text:=floattostr(ab.total_litros);
editPPL.Text:=floattostr(ab.PU);
editTempo.Text:=ab.tempo;
editCanal.Text:=ab.canal;
editData.Text:=ab.data;
editHora.text:=ab.hora;
editRegistro.Text:=floattostr(ab.registro);
editEnc.Text:=floattostr(ab.encerrante);
editTag.text:=ab.tag;
check.Checked:=ab.checksum;
integridade.Checked:=ab.integridade;
value.Checked:=ab.value;
end;

procedure TForm1.Button27Click(Sender: TObject);
var ms:multistatus;
    a:byte;
begin
ms:=LeStatusFid;
for a:=1 to 32 do
    begin
    case ms.Status[a] of
    Livre:ListBox2.Items.Add(inttostr(a) + ' (L) - Livre');
    Pronta:ListBox2.Items.Add(inttostr(a) + ' (P) - Pronto');
    Falha:ListBox2.Items.Add(inttostr(a) + ' (F) - Falha');
    Concluiu:ListBox2.Items.Add(inttostr(a) + ' (C) - Concluiu');
    Abastecendo:ListBox2.Items.Add(inttostr(a) + ' (A) - Abastecimento');
    Bloqueada:ListBox2.Items.Add(inttostr(a) + ' (B) - Bloqueado');
    SolicitaLib:ListBox2.Items.Add(inttostr(a) + ' (E) - Espera');
    end;
    end;
end;

procedure TForm1.Button28Click(Sender: TObject);
var ab:abast3;
begin
CobLeStructIDSt(ab);
//memo7.Clear;
memo7.Lines.Add('Ident. : ' + ab.id);
memo7.Lines.Add('Total  : ' + ab.total_dinheiro);
memo7.Lines.Add('String : ' + ab.st_full);
memo7.Lines.Add('Volume : ' + ab.total_litros);
memo7.Lines.Add('P.Unit : ' + ab.PU);
memo7.Lines.Add('Tempo  : ' + ab.tempo);
memo7.Lines.Add('Bico   : ' + ab.canal);
memo7.Lines.Add('Data   : ' + ab.data);
memo7.Lines.Add('Hora   : ' + ab.hora);
memo7.Lines.Add('Reg    : ' + ab.registro);
memo7.Lines.Add('Enc.L. : ' + ab.encerrante);
memo7.Lines.Add('--------------------------------');
end;



procedure TForm1.Button29Click(Sender: TObject);
begin
edit22.text:=LeEvento(strtoint(edit21.text));
end;

procedure TForm1.Button30Click(Sender: TObject);
begin
if InicializaSocket(edit23.text) then
  begin
  radiobutton6.Checked:=true;
  button30.Enabled:=false;
  button31.Enabled:=true;
  end
else
  begin
  radiobutton7.Checked:=true;
  button31.Enabled:=false;
  button30.Enabled:=true;
  end;
end;

procedure TForm1.Button31Click(Sender: TObject);
begin
if FechaSocket then
  radiobutton7.Checked:=true
else
  radiobutton6.Checked:=true;
end;

procedure TForm1.Button32Click(Sender: TObject);
begin
RadioButton6.Checked:=SocketOpen;
RadioButton7.Checked:=not RadioButton6.Checked;
Button30.Enabled:=not RadioButton6.Checked;
Button31.Enabled:=not Button30.Enabled;
end;

procedure TForm1.Button33Click(Sender: TObject);
begin
edit25.Text:=floattostr(LePPL(edit24.text));
end;

procedure TForm1.Button34Click(Sender: TObject);
var st:string;
begin
st:=LeStStatus2;
edit1.Text:=st;
end;

procedure TForm1.FormCreate(Sender: TObject);
begin
width:=692;
height:=470;
end;

procedure TForm1.Button35Click(Sender: TObject);
begin
WriteSerial(edit26.text,length(edit26.text));
end;

procedure TForm1.Button36Click(Sender: TObject);
begin
edit27.Text:='';
edit27.Repaint;
edit27.Text:=ReadSerial(1000);
end;

end.
